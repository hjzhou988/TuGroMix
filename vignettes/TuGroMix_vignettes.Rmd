---
title: "TuGroMix"
author: "Huajun Zhou"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{TuGroMix}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
# devtools::load_all()
```

This TuGroMix package uses linear mixed-effects model (LMM) and exponential growth rate (eGR) to model transplanted tumor growth in research mice. Compared to the widely-used tumor growth inhibition (TGI), which is based on a single-day's tumor volumes, LMM and eGR took advantage of full time-range of observation data and calculate drug-treatment effect on tumor growth rate, which is a more accurate statistic to describe the mean difference in tumor growth. 


## Usage

The basic usage of this package is to estimate tumor growth rate difference between experimental groups, and how significant is that the difference does not equal to 0. It can be used as an alternative to the usual t-test/ANOVA for hypothesis testing. lmmFit() and get_Model_eGR() are used for this purpose.

The more important usage of this package is to search for genes that are associated with drug treatment efficacy. It can be mutation status (0,1) or expression level (log2TPM) of a gene that affect drug efficacy. lmmscreen() and eGRscreen() are used for this purpose.

## Convert data
Mouse tumor growth data are usually presented with each mouse as a row, and each time point as a column. This data format needs to be converted to a "long" format, before it can be used as an input data matrix for LMM and GAMM model building. wide2long() provides with this function.

Firstly, we load required packages
```{r}
library(TuGroMix)
```

We read in our example data, and convert it to long format
```{r}
data(tv_data)

tv_wide.long = wide2long(tv_data = tv_wide,id.vars = c("Group","Animal.No."))
```

## Calculate tumor growth inhibition (TGI) with 90% confidence interval
Tumor growth inhibition has 6 definitions -- 1: TV_trt/TV_ctl, 2: DeltaTV_trt/DeltaTV_ctl, 3: 1-DeltaTV_trt/DeltaTV_ctl, 4:RTV_trt/RTV_ctl, 5: 1-TV_trt/TV_ctl, 6: 1-RTV_trt/RTV_ctl. The day for calculating TGI will be automatically selected as the last day where there are at least 60% tumors available in both treated and reference groups. The confidence interval span can also be specified. The confidence interval is determined by 1000 times bootstrapping. 
```{r}
tgi.res = get_Model_TGI(tv.data = tv_wide.long,ref.group = "G1",def = 6, group.id.var = "Group",mouse.id.var = "Animal.No.",time.var = "Day",tv.var = "TV",ci = T,bound = 90)

knitr::kable(tgi.res)
```
The 90% confidence interval contains 0, so tumor growth inhibition is not statistically significant in this case. 

## Test whether there is significant difference in tumor growth rates between groups 
Then use lmmFit to test growth rate difference between groups. 
```{r}
lmmfit.res = lmmFit(tv.data = tv_wide.long,ref.group = "G1",group.id.var = "Group",mouse.id.var = "Animal.No.")

knitr::kable(lmmfit.res$coefs)
```
The second row "Estimate" column tells you the difference in growth rates between Group 2 and the reference group. The first row "Estimate" column, however, is the estimated growth rate of the reference group. p-value in the first row indicates whether the growth rate of the reference group is significantly different from 0. p-value in the second row indicates whether the growth rate of Group 2 is significantly different from the growth rate of the reference group.

## Visualize data points and fitted lines.
Plot lmmFit result
```{r}
plot(lmmfit.res)
```
Note that the y axis is in the log scale. The reason that TV is added by 1 is to prevent the log 0 case. The dots are the log-transformed data points. The straight lines and ribbons are fitted curves and 95% confidence interval.


## Test by eGR difference
use eGR difference to test growth rate difference between groups.
```{r}
eGR.res = get_Model_eGR(tv.data = tv_wide.long,ref.group = "G1",group.id.var = "Group",mouse.id.var = "Animal.No.", time.var = "Day",tv.var = "TV",ci = T,type = "difference")

knitr::kable(eGR.res)
```
The 90% confidence interval of eGR difference was obtained by 1000 times bootstrapping. It contains 0, so the eGR difference is not statistically significant between G2 and reference group. The function also supports calculating eGR ratio by specifying the argument type. 


## Screening for biomarkers that affect drug efficacy by LMM
Gene expression in log2TPM is recommended. If you have log2FPKM or FPKM data, you can convert it to log2TPM using fpkm2tpm() function.
```{r}
data(screen) # load screen data, which includes tv data and gene expression data.
```

The gene expression is usually in the form of each row being a gene, and each column being a biological sample (mouse model). Transpose the gene expression data first, so that each column is a gene and each row is mouse model, using transpose() function.
```{r}
expre.screen.X =  transpose(data.thin = expres.screen, gene.id = rownames(expres.screen))

screen.res = lmmscreen(tv.data = tv.data.screen, ref.group = "Vehicle",
                       model.var = "Model", 
                       group.var = "Trt", 
                       mouse.id.var = "Mouse.ID",
                       time.var = "Day",
                       tv.var = "TV",
                       gene.expr.data = expre.screen.X)

## screening result is ordered by p-values.
knitr::kable(screen.res)
```

## Screen for biomarkers that affect drug efficacy by eGR difference

```{r}
## Use eGR difference for biomarker screening. 
eGR.screen.res = eGRscreen(tv.data = tv.data.screen, ref.group = "Vehicle",model.var = "Model", group.var = "Trt", mouse.id.var = "Mouse.ID", time.var="Day", tv.var="TV", gene.expr.data = expre.screen.X, type = "diff")

## eGR result
knitr::kable(eGR.screen.res$eGR)
```



```{r}
## screening result is ordered by p-values.
knitr::kable(eGR.screen.res$cor)
```



